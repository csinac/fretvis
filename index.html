<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fretboard Visualizer</title>
    <link rel="stylesheet" href="fretboard.css">
</head>
<body>
    <div class="container">
        <h1>Fretboard Visualiser</h1>
        <p style="margin-bottom: 12px;">A work-in-progress vibe coding experiment.</p>
        <p>
            Add fretboards to create fretboard diagrams.<br/>
            Add / remove strings for different guitar types (6 string, bass, 12 string, etc.) <br/>
            Change Labels for string annotations <br/>
            Add [fret number, finger annotation] pairs, separated by commas. type "x" for a muted string, "o" for an open string.</p>
        <div class="controls">
            <div>
                <label>Handedness:</label>
                <label><input type="radio" name="handedness" value="right" checked> Right</label>
                <label><input type="radio" name="handedness" value="left"> Left</label>
            </div>
            <div>
                <label>Viewpoint:</label>
                <label><input type="radio" name="viewpoint" value="top" checked> Front</label>
                <label><input type="radio" name="viewpoint" value="front"> Top</label>
            </div>
            <button class="add-fret-btn" type="button">Add Fretboard</button>
        </div>
        <div class="fretboard-gallery" id="fretboard-gallery">
            <!-- Fretboard views will be inserted here -->
        </div>
    </div>

    <template id="fret-view-template">
        <div class="fret-view">
            <div class="fret-view-header">
                <strong>Fretboard</strong>
                <button class="toggle-btn" type="button">Hide Inputs</button>
            </div>
            <div class="fret-view-inputs">
                <div class="fret-label-row" style="margin-bottom: 6px;">
                    <label>Fret Label: <input type="text" class="fret-label-input" placeholder="Optional label (e.g. Cmaj7)"></label>
                </div>
                <div class="string-inputs">
                    <!-- String blocks will be inserted here -->
                </div>
                <button class="add-string-btn" type="button">Add String</button>
            </div>
            <div class="fret-view-diagram">
                <!-- Canvas will be inserted here by ensureCanvas -->
            </div>
            <button class="remove-fret-btn" type="button">Remove Fretboard</button>
        </div>
    </template>

    <template id="string-block-template">
        <div class="string-block">
            <label>Label: <input type="text" class="string-label" value="E"></label>
            <label class="string-frets-fingers-label">Frets/Fingers: <input type="text" class="string-frets-fingers" placeholder="e.g. 3,1 5,3 open"></label>
            <button class="remove-string-btn" type="button">Remove</button>
        </div>
    </template>

    <script type="module">
    import { createStringBlock, createFretView } from './fretboardBlocks.js';
    import { attachFretboardValidation, parseAndValidateFretboard } from './parseFretboard.js';
    import { renderFretboard, palette } from './renderFretboard.js';
    
    const fretboardGallery = document.getElementById('fretboard-gallery');
    const addFretBtn = document.querySelector('.add-fret-btn');
    // handednessSelect and viewpointSelect will be queried directly when needed

    function ensureCanvas(fretView) {
        let canvas = fretView.querySelector('canvas.fretboard-canvas');
        if (!canvas) {
            const canvasContainer = fretView.querySelector('.fret-view-diagram'); // Assuming you have a container for the canvas
            if(canvasContainer){
                canvas = document.createElement('canvas');
                canvas.className = 'fretboard-canvas';
                canvas.style.display = 'block'; // Default to block, might be hidden by renderAll if error
                canvas.style.margin = '20px auto'; // Center it
                canvasContainer.appendChild(canvas);
            } else {
                // Fallback if no specific container, append to fretView itself
                console.warn('Canvas container .fret-view-diagram not found, appending canvas to fretView root.');
                canvas = document.createElement('canvas');
                canvas.className = 'fretboard-canvas';
                canvas.style.display = 'block';
                canvas.style.margin = '20px auto';
                fretView.appendChild(canvas);
            }
        }
        return canvas;
    }

    function renderAllFretboards() {
        const fretViews = fretboardGallery.querySelectorAll('.fret-view');
        fretViews.forEach(fretView => {
            const parsedData = parseAndValidateFretboard(fretView);
            const canvas = ensureCanvas(fretView);
            if (!canvas) return; // Should not happen if ensureCanvas works

            if (!parsedData.error) {
                const currentHandedness = document.querySelector('input[name="handedness"]:checked').value;
                const currentViewpoint = document.querySelector('input[name="viewpoint"]:checked').value;
                renderFretboard({
                    canvas: canvas,
                    data: parsedData,
                    handedness: currentHandedness,
                    viewpoint: currentViewpoint
                });
                canvas.style.display = 'block'; // Ensure canvas is visible for valid data
            } else {
                // Optional: Clear canvas or hide it on error
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvas.style.display = 'none'; // Hide canvas on error
                // You could also draw an error message on the canvas here
            }
        });
    }

    // Add fretboard logic
    addFretBtn.addEventListener('click', () => {
        const fretView = createFretView(renderAllFretboards);
        fretboardGallery.appendChild(fretView);
        attachFretboardValidation(fretView, renderAllFretboards); // Pass callback
        renderAllFretboards(); // Initial render for the new fretView
    });

    // Initialize with one fretboard by default
    const initialFretView = createFretView(renderAllFretboards);
    fretboardGallery.appendChild(initialFretView);
    attachFretboardValidation(initialFretView, renderAllFretboards); // Pass callback
    renderAllFretboards(); // Initial render

    // Event listeners for global controls
    document.querySelectorAll('input[name="handedness"]').forEach(radio => {
        radio.addEventListener('change', renderAllFretboards);
    });
    document.querySelectorAll('input[name="viewpoint"]').forEach(radio => {
        radio.addEventListener('change', renderAllFretboards);
    });

    // Ensure initial render if content is already there (e.g. page refresh with form data)
    // This might be redundant if the above initialFretView logic always runs on load.
    // renderAllFretboards(); 
    </script>
</body>
</html>
